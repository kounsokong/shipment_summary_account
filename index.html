<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shipment Summary - Angkobodia Logistics Co., Ltd</title>
<style>
  @page { size: A4; margin: 10mm; }
  body { font-family: "Arial", "Khmer OS Battambang", sans-serif; font-size: 13px; color: #000; margin: 0; padding: 0; }
  .container { width: 100%; max-width: 210mm; margin: 0 auto; padding: 10px; box-sizing: border-box; }
  .header { display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 8px; }
  .header img { height: 60px; }
  .header-text { text-align: right; }
  .header-text h2 { margin: 0; font-size: 20px; color: #002060; }
  h3.title { text-align: center; margin-top: 10px; font-size: 18px; text-transform: uppercase; }
  table { width: 100%; border-collapse: collapse; margin-top: 5px; }
  th, td { border: 1px solid #000; padding: 6px 8px; vertical-align: middle; }
  th { background: #f9f9f9; text-align: center; }
  .section-title { font-weight: bold; background: #f2f2f2; text-transform: uppercase; text-align: center; }
  .notes { margin-top: 4px; font-size: 12px; }
  .right { text-align: right; }
  .bold { font-weight: bold; }
  .print-button { position: fixed; top: 20px; right: 20px; padding: 12px 24px; background-color: #002060; color: white; border: none; border-radius: 5px; cursor: pointer; z-index: 1000; }
  @media print { .print-button { display: none; } }
</style>
</head>
<body>

  <button class="print-button" onclick="window.print()">üñ®Ô∏è Print</button>

  <div class="container" id="documentContainer">
    <div class="header">
      <div class="logo"><img src="logo.png" alt="Logo" onerror="this.style.display='none'"></div>
      <div class="header-text"><h2>Angkobodia Logistics Co., Ltd</h2></div>
    </div>

    <h3 class="title">Shipment Summary</h3>

    <table>
      <tr><td>DATE: <b id="date"></b></td><td>BL.: <b id="bill_of_lading"></b></td></tr>
      <tr><td>JOB NO: <b id="lot_no"></b></td><td>CNTR No: <b id="container_nos"></b></td></tr>
      <tr><td>SHIPMENT MODE: <b id="job_type"></b></td><td>ETD: <b id="etd"></b></td></tr>
      <tr><td>VOLUME: <b><span id="total_pkg"></span><span id="unit"></span></b></td><td>INV#: <b id="invoice_no"></b></td></tr>
      <tr><td>GROSS WEIGHT: <b id="total_gw"></b></td><td>CUSTOMER: <b><span id="customer"></span>: <span id="customer_name"></span></b></td></tr>
      <tr><td>CBM: <b id="cbm"></b></td><td>OPERATOR: <b id="operator"></b></td></tr>
    </table>

    <table>
      <tr><th style="width: 50%;">SPECIAL CASE</th><th style="width: 50%;">REMARKS SELL FACTORY</th></tr>
      <tr><td id="special_case" style="white-space: pre-wrap;"></td><td id="remark_sell_factory" style="white-space: pre-wrap;"></td></tr>
    </table>

    <p class="notes"><b>Notes:</b> <span id="remarks"></span></p>

    <table>
      <tr><th colspan="6" class="section-title">CONTAINER</th></tr>
      <tr><th>No</th><th>CONTAINER#</th><th>CARRIER NAME</th><th>BUYING</th><th>SELLING</th><th>DEPOSIT</th></tr>
      <tbody id="containerTableBody"></tbody>
    </table>

    <table>
      <tr><th colspan="6" class="section-title">EXPENSE SUMMARY</th></tr>
      <tr>
        <th style="width: 12%;">DATE</th>
        <th style="width: 23%;">VENDOR</th>
        <th style="width: 30%;">DESCRIPTION</th>
        <th style="width: 10%;">SELLING</th>
        <th style="width: 10%;">BUYING</th>
        <th style="width: 15%;">PROFIT</th>
      </tr>
      <tbody id="expenseTableBody"></tbody>
      <tr class="bold">
        <td colspan="3" class="right">TOTAL</td>
        <td id="revenue" class="right"></td>
        <td id="operating_expense" class="right"></td>
        <td id="gross_profit" class="right"></td>
      </tr>
    </table>
  </div>

  <script>
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      const data = {};
      for (const [key, value] of params) { data[key] = decodeURIComponent(value); }
      return data;
    }

    function parseJsonParam(param) { try { return JSON.parse(param); } catch (e) { return []; } }

    function cleanNum(val) {
      if (!val) return 0;
      let num = parseFloat(String(val).replace(/[^0-9.-]+/g, ""));
      return isNaN(num) ? 0 : num;
    }

    function formatCur(num) {
      return num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function populateDocument() {
      const p = getUrlParams();

      // Basic Text Fields
      ["date", "bill_of_lading", "lot_no", "container_nos", "job_type", "etd", "total_pkg", "unit", "invoice_no", "total_gw", "customer", "customer_name", "cbm", "operator", "special_case", "remark_sell_factory", "remarks", "revenue", "operating_expense", "gross_profit"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = p[id] || '';
      });

      // Container Rows
      const containerBody = document.getElementById('containerTableBody');
      const containers = parseJsonParam(p.containers);
      containers.forEach((c, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `<td style="text-align:center">${i+1}</td><td>${c.container_no||''}<br>${c.size||'' }</td><td>${c.carrier_name||''}<br>${c.seal_no||''}</td><td style="white-space:pre-wrap">${c.buying||''}</td><td style="white-space:pre-wrap">${c.selling||''}</td><td class="right">${c.deposit||''}</td>`;
        containerBody.appendChild(row);
      });

      // --- EXPENSE MERGING LOGIC ---
      const expenseBody = document.getElementById('expenseTableBody');
      const exp1 = parseJsonParam(p.expenses1); // Table for Selling
      const exp2 = parseJsonParam(p.expenses2); // Table for Buying
      
      const mergedMap = {};

      // 1. Process Selling Table (exp1)
      exp1.forEach(item => {
        const desc = item.description || "N/A";
        if (!mergedMap[desc]) {
          mergedMap[desc] = { date: item.date, vendor: item.vendor, description: desc, selling: 0, buying: 0 };
        }
        mergedMap[desc].selling += cleanNum(item.selling_amount);
      });

      // 2. Process Buying Table (exp2) - Map buying amounts to the same descriptions
      exp2.forEach(item => {
        const desc = item.description || "N/A";
        if (!mergedMap[desc]) {
          // If description wasn't in Selling table, create new entry
          mergedMap[desc] = { date: item.date, vendor: item.vendor, description: desc, selling: 0, buying: 0 };
        }
        mergedMap[desc].buying += cleanNum(item.buying_amount);
        
        // Use the vendor from the buying table if the selling table didn't have one
        if (!mergedMap[desc].vendor) mergedMap[desc].vendor = item.vendor;
      });

      // 3. Render the merged list
      const finalItems = Object.values(mergedMap);
      if (finalItems.length > 0) {
        finalItems.forEach(item => {
          const profit = item.selling - item.buying;
          const row = document.createElement('tr');
          row.innerHTML = `
            <td style="text-align:center">${item.date || ''}</td>
            <td>${item.vendor || ''}</td>
            <td>${item.description}</td>
            <td class="right">${formatCur(item.selling)}</td>
            <td class="right">${formatCur(item.buying)}</td>
            <td class="right">${formatCur(profit)}</td>
          `;
          expenseBody.appendChild(row);
        });
      } else {
        expenseBody.innerHTML = '<tr><td colspan="6" style="text-align:center">No records found</td></tr>';
      }
    }

    window.addEventListener('DOMContentLoaded', populateDocument);
  </script>
</body>
</html>
